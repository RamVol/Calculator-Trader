<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bybit USDT (Linear Perp) — калькулятор по марже (.P)</title>
  <style>
    :root {
      --bg: #050816;
      --card: #0b1220;
      --border: rgba(255,255,255,0.08);
      --border-soft: rgba(255,255,255,0.05);
      --t: #f9fafb;
      --t-soft: #9ca3af;
      --good: #22c55e;
      --bad: #ef4444;
      --input-bg: #020617;
    }
    * { box-sizing: border-box; }
    body {
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
      background:radial-gradient(circle at top,#111827 0,#020617 55%);
      color:var(--t);
    }
    .wrap{max-width:1080px;margin:20px auto;padding:0 14px 24px;}
    .card{
      background:var(--card);
      border-radius:14px;
      border:1px solid var(--border);
      padding:14px;
      box-shadow:0 18px 45px rgba(0,0,0,0.55);
    }
    h1{margin:0 0 12px;font-size:18px;font-weight:600;}
    .subtitle{margin-bottom:10px;font-size:12px;color:var(--t-soft);}
    label{
      display:block;
      margin:8px 0 4px;
      font-size:12px;
      color:var(--t-soft);
    }
    input,select,button{
      width:100%;
      padding:9px 11px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--input-bg);
      color:var(--t);
      font-size:13px;
      font-family:inherit;
    }
    input::placeholder{color:#6b7280;}
    input[disabled]{opacity:.7;cursor:not-allowed;}
    button{
      background:#111827;
      font-weight:600;
      cursor:pointer;
      transition:background .15s,transform .05s;
    }
    button:hover{background:#1f2937;}
    button:active{transform:translateY(1px);}
    .btn-primary{
      background:linear-gradient(135deg,#2563eb,#4f46e5);
      border-color:rgba(59,130,246,0.6);
    }
    .btn-primary:hover{filter:brightness(1.05);}
    .grid{
      display:grid;
      grid-template-columns:1.08fr 0.92fr;
      gap:12px;
      align-items:flex-start;
    }
    @media(max-width:980px){.grid{grid-template-columns:1fr;}}
    .row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
      margin-bottom:6px;
    }
    @media(max-width:520px){.row{grid-template-columns:1fr;}}
    .combo{position:relative;}
    .dropdown{
      position:absolute;
      left:0;right:0;top:calc(100% + 4px);
      background:#020617;
      border-radius:10px;
      border:1px solid var(--border);
      max-height:260px;
      overflow:auto;
      z-index:20;
      display:none;
    }
    .dropdown.open{display:block;}
    .item{
      padding:8px 10px;
      border-bottom:1px solid var(--border-soft);
      font-size:13px;
      cursor:pointer;
    }
    .item:last-child{border-bottom:none;}
    .item:hover{background:#020617;filter:brightness(1.12);}
    .item-line{
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:center;
    }
    .item-sym{font-weight:600;}
    .item-base{color:var(--t-soft);}
    .small{font-size:11px;color:var(--t-soft);margin-top:4px;}
    .small-row{
      display:flex;
      justify-content:space-between;
      gap:8px;
      font-size:11px;
      color:var(--t-soft);
      margin-top:4px;
    }
    .kpi{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
    }
    @media(max-width:520px){.kpi{grid-template-columns:1fr;}}
    .box{
      border-radius:12px;
      border:1px solid var(--border);
      background:radial-gradient(circle at top left,#111827 0,#020617 55%);
      padding:10px;
    }
    .box .t{font-size:11px;color:var(--t-soft);margin-bottom:4px;}
    .box .v{font-size:18px;font-variant-numeric:tabular-nums;line-height:1.2;}
    .good{color:var(--good);}
    .bad{color:var(--bad);}
    .hr{height:1px;background:var(--border-soft);margin:10px 0;}
    #warndiv{font-size:11px;color:var(--t-soft);line-height:1.4;min-height:1em;}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Bybit USDT (Linear Perp) — калькулятор по марже (.P)</h1>
    <div class="subtitle">
      Вводишь маржу в USDT — калькулятор показывает, сколько монет можно открыть с учётом плеча,
      PnL по SL/TP и стоимость пункта. ZORAUSDT.P доступна в списке.
    </div>

    <div class="grid">
      <!-- Левая панель -->
      <div>
        <div class="row">
          <div>
            <label for="side">Направление</label>
            <select id="side">
              <option value="long">LONG</option>
              <option value="short">SHORT</option>
            </select>
          </div>
          <div>
            <label for="lev">Плечо (x)</label>
            <input id="lev" type="number" min="1" step="0.1" value="20">
          </div>
        </div>

        <div class="row">
          <div class="combo">
            <label for="instrumentInput">Инструмент (.P как в TV)</label>
            <input id="instrumentInput" type="text" autocomplete="off"
                   placeholder="Например ZORAUSDT.P / BTCUSDT.P">
            <div id="instrumentDropdown" class="dropdown"></div>
            <div class="small-row">
              <span id="apiHint"></span>
              <span id="foundHint"></span>
            </div>
          </div>
          <div>
            <label for="entry">Цена входа</label>
            <input id="entry" type="number" min="0" step="0.000001" value="">
          </div>
        </div>

        <!-- Маржа + количество монет на эту маржу -->
        <div class="row">
          <div>
            <label for="marginInput">Маржа (USDT, сколько готов поставить)</label>
            <input id="marginInput" type="number" min="0" step="0.01" value="25">
          </div>
          <div>
            <label>Сколько монет на эту маржу</label>
            <input id="qtyDisplay" type="text" disabled value="—">
          </div>
        </div>

        <div class="row">
          <div>
            <label for="sl">Stop-Loss цена</label>
            <input id="sl" type="number" min="0" step="0.000001" value="">
          </div>
          <div>
            <label for="tp">Take-Profit цена</label>
            <input id="tp" type="number" min="0" step="0.000001" value="">
          </div>
        </div>

        <div class="row">
          <div>
            <button id="calcBtn" type="button" class="btn-primary">Рассчитать</button>
          </div>
          <div>
            <button id="refreshBtn" type="button">Обновить цену с Bybit</button>
          </div>
        </div>

        <div class="row">
          <div>
            <button id="resetBtn" type="button">Сброс</button>
          </div>
        </div>
      </div>

      <!-- Правая панель -->
      <div>
        <div class="kpi">
          <div class="box">
            <div class="t">1) Take-Profit и прибыль</div>
            <div class="v" id="outTP">—</div>
            <div class="v good" id="outProfit">—</div>
          </div>

          <div class="box">
            <div class="t">2) Stop-Loss и убыток</div>
            <div class="v" id="outSL">—</div>
            <div class="v bad" id="outLoss">—</div>
          </div>

          <div class="box">
            <div class="t">3) Номинал позиции</div>
            <div class="v" id="outNotionalMain">—</div>
            <div class="small" id="outNotionalHint"></div>
          </div>

          <div class="box">
            <div class="t">4) Стоимость 1 пункта (тик 0.0001)</div>
            <div class="v" id="outTickValue">—</div>
            <div class="small" id="outTickHint"></div>
          </div>
        </div>

        <div class="hr"></div>
        <div id="warndiv"></div>
      </div>
    </div>
  </div>
</div>

<script>
  const $ = id => document.getElementById(id);

  const sideEl     = $('side');
  const levEl      = $('lev');
  const instrInput = $('instrumentInput');
  const dropdown   = $('instrumentDropdown');
  const apiHint    = $('apiHint');
  const foundHint  = $('foundHint');
  const entryEl    = $('entry');
  const marginEl   = $('marginInput');
  const qtyDisplay = $('qtyDisplay');
  const slEl       = $('sl');
  const tpEl       = $('tp');

  const outNotionalMain = $('outNotionalMain');
  const outNotionalHint = $('outNotionalHint');
  const outSL           = $('outSL');
  const outLoss         = $('outLoss');
  const outTP           = $('outTP');
  const outProfit       = $('outProfit');
  const outTickValue    = $('outTickValue');
  const outTickHint     = $('outTickHint');
  const warnDiv         = $('warndiv');

  const calcBtn    = $('calcBtn');
  const refreshBtn = $('refreshBtn');
  const resetBtn   = $('resetBtn');

  const symbols = [
    { apiSymbol:'BTCUSDT',   tvSymbol:'BTCUSDT.P',   base:'BTC',   quote:'USDT' },
    { apiSymbol:'ETHUSDT',   tvSymbol:'ETHUSDT.P',   base:'ETH',   quote:'USDT' },
    { apiSymbol:'SOLUSDT',   tvSymbol:'SOLUSDT.P',   base:'SOL',   quote:'USDT' },
    { apiSymbol:'ZORAUSDT',  tvSymbol:'ZORAUSDT.P',  base:'ZORA',  quote:'USDT' },
    { apiSymbol:'ZKUSDT',    tvSymbol:'ZKUSDT.P',    base:'ZK',    quote:'USDT' },
    { apiSymbol:'ZROUSDT',   tvSymbol:'ZROUSDT.P',   base:'ZRO',   quote:'USDT' },
    { apiSymbol:'ZILUSDT',   tvSymbol:'ZILUSDT.P',   base:'ZIL',   quote:'USDT' },
  ];
  apiHint.textContent = `Инструментов: ${symbols.length}. Пиши 1 символ — фильтр.`;

  function renderDropdown(list) {
    dropdown.innerHTML = '';
    if (!list.length) {
      dropdown.classList.remove('open');
      foundHint.textContent = 'Ничего не найдено';
      return;
    }
    list.slice(0, 200).forEach(s => {
      const el = document.createElement('div');
      el.className = 'item';
      el.innerHTML = `
        <div class="item-line">
          <span class="item-sym">${s.tvSymbol}</span>
          <span class="item-base">${s.base}/${s.quote}</span>
        </div>
      `;
      el.addEventListener('click', () => {
        instrInput.value = s.tvSymbol;
        dropdown.classList.remove('open');
        foundHint.textContent = `${s.base}/${s.quote}`;
        fetchLastPrice(s.apiSymbol);
      });
      dropdown.appendChild(el);
    });
    dropdown.classList.add('open');
    foundHint.textContent = `Найдено: ${list.length}`;
  }

  instrInput.addEventListener('input', () => {
    let q = instrInput.value.trim().toUpperCase();
    if (!q) {
      dropdown.classList.remove('open');
      foundHint.textContent = '';
      return;
    }
    q = q.replace(/\.P\b/i, '');
    const parts = q.split(/\s+/).filter(Boolean);

    const list = symbols.filter(s => {
      const text = `${s.apiSymbol} ${s.tvSymbol} ${s.base}`.toUpperCase();
      return parts.every(p => text.includes(p));
    });
    renderDropdown(list);
  });

  document.addEventListener('click', e => {
    if (!dropdown.contains(e.target) && e.target !== instrInput) {
      dropdown.classList.remove('open');
    }
  });

  async function fetchLastPrice(symbol) {
    if (!symbol) return;
    try {
      apiHint.textContent = `Цена для ${symbol}...`;
      const url =
        'https://api.bybit.com/v5/market/tickers?category=linear&symbol=' +
        encodeURIComponent(symbol);
      const res = await fetch(url);
      const data = await res.json();
      if (data.retCode !== 0 || !data.result?.list?.length) {
        throw new Error(data.retMsg || 'no data');
      }
      const px = Number(data.result.list[0].lastPrice);
      if (!isFinite(px)) throw new Error('bad price');
      entryEl.value = px;
      apiHint.textContent = `Last price: ${px}`;
    } catch (e) {
      console.error(e);
      apiHint.textContent = 'Ошибка API Bybit (ticker)';
    }
  }

  refreshBtn.addEventListener('click', () => {
    let sym = instrInput.value.trim().toUpperCase();
    if (!sym) {
      apiHint.textContent = 'Сначала выбери инструмент';
      return;
    }
    sym = sym.replace(/\.P\b/i, '');
    fetchLastPrice(sym);
  });

  function calc() {
    warnDiv.textContent = '';

    const side  = sideEl.value;
    const lev   = Number(levEl.value);
    const entry = Number(entryEl.value);
    const margin= Number(marginEl.value);
    const sl    = Number(slEl.value);
    const tp    = Number(tpEl.value);

    if (!entry || !margin || !lev) {
      warnDiv.textContent = 'Нужно минимум указать: цену входа, маржу и плечо.';
      return;
    }

    const notional = margin * lev;
    const qtyRaw   = notional / entry;

    const qty = Math.floor(qtyRaw);
    qtyDisplay.value = qty + ' монет';

    let pnlSL = NaN;
    let pnlTP = NaN;

    if (sl) {
      pnlSL = side === 'long'
        ? (sl - entry) * qty
        : (entry - sl) * qty;
    }
    if (tp) {
      pnlTP = side === 'long'
        ? (tp - entry) * qty
        : (entry - tp) * qty;
    }

    outNotionalMain.textContent = notional.toFixed(2) + ' USDT';
    outNotionalHint.textContent =
      `Номинал = маржа × плечо = ${margin.toFixed(2)} × ${lev.toFixed(2)} = ${notional.toFixed(2)} USDT.`;

    outTP.textContent    = tp ? tp.toFixed(6) : '—';
    outProfit.textContent= isFinite(pnlTP) ? pnlTP.toFixed(2) + ' USDT' : '—';

    outSL.textContent   = sl ? sl.toFixed(6) : '—';
    outLoss.textContent = isFinite(pnlSL) ? pnlSL.toFixed(2) + ' USDT' : '—';

    const TICK = 0.0001;
    const tickValue = qty * TICK;
    outTickValue.textContent = tickValue.toFixed(4) + ' USDT';
    outTickHint.textContent  =
      `При изменении цены на 0.0001 PnL изменится примерно на ${tickValue.toFixed(4)} USDT.`;

    const riskPct   = margin ? (pnlSL / margin * 100) : NaN;
    const rewardPct = margin ? (pnlTP / margin * 100) : NaN;

    let msg = [];
    if (isFinite(riskPct))
      msg.push(`Убыток по SL ≈ ${riskPct.toFixed(1)}% от маржи`);
    if (isFinite(rewardPct))
      msg.push(`Профит по TP ≈ ${rewardPct.toFixed(1)}% от маржи`);

    warnDiv.textContent = msg.join(' · ');
  }

  calcBtn.addEventListener('click', calc);

  resetBtn.addEventListener('click', () => {
    sideEl.value   = 'long';
    levEl.value    = 20;
    instrInput.value = '';
    entryEl.value  = '';
    marginEl.value = 25;
    slEl.value     = '';
    tpEl.value     = '';

    dropdown.classList.remove('open');
    foundHint.textContent = '';
    apiHint.textContent   = `Инструментов: ${symbols.length}. Пиши 1 символ — фильтр.`;

    qtyDisplay.value      = '—';
    outNotionalMain.textContent = '—';
    outNotionalHint.textContent = '';
    outSL.textContent           = '—';
    outLoss.textContent         = '—';
    outTP.textContent           = '—';
    outProfit.textContent       = '—';
    outTickValue.textContent    = '—';
    outTickHint.textContent     = '';
    warnDiv.textContent         = '';
  });
</script>
</body>
</html>