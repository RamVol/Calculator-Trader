<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bybit USDT (Linear Perp) — калькулятор по марже (.P)</title>
  <style>
    :root {
      --bg: #050816;
      --card: #0b1220;
      --border: rgba(255, 255, 255, 0.08);
      --bordersoft: rgba(255, 255, 255, 0.05);
      --t: #f9fafb;
      --tsoft: #9ca3af;
      --good: #22c55e;
      --bad: #ef4444;
      --inputbg: #020617;
    }
    *, *::before, *::after { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
      background: radial-gradient(circle at top, #111827, #020617 55%);
      color: var(--t);
    }
    .wrap { max-width: 1180px; margin: 20px auto; padding: 0 14px 24px; }
    .card {
      background: var(--card);
      border-radius: 18px;
      border: 1px solid var(--border);
      padding: 18px 18px 20px;
      box-shadow: 0 18px 45px rgba(0,0,0,0.55);
    }
    h1 { margin: 0 0 8px; font-size: 18px; font-weight: 600; }
    .subtitle { margin-bottom: 14px; font-size: 12px; color: var(--tsoft); }
    label {
      display:block;
      margin: 6px 0 4px;
      font-size: 12px;
      color: var(--tsoft);
    }
    input, select, button {
      width:100%;
      padding:9px 11px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--inputbg);
      color:var(--t);
      font-size:13px;
      font-family:inherit;
      outline:none;
    }
    input::placeholder { color:#6b7280; }
    button {
      background:#111827;
      font-weight:600;
      cursor:pointer;
      transition:background .15s, transform .05s, filter .15s;
    }
    button:hover { background:#1f2937; }
    button:active { transform:translateY(1px); }
    .btn-primary {
      background:linear-gradient(135deg,#2563eb,#4f46e5);
      border-color:rgba(59,130,246,.7);
    }
    .btn-primary:hover { filter:brightness(1.05); }
    .grid {
      display:grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap:14px;
      align-items:flex-start;
    }
    @media (max-width:980px){ .grid{ grid-template-columns:1fr; } }
    .row {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-bottom:6px;
    }
    @media (max-width:600px){ .row{ grid-template-columns:1fr; } }

    .kpi {
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    @media (max-width:600px){ .kpi{ grid-template-columns:1fr; } }
    .box {
      border-radius:14px;
      border:1px solid var(--border);
      background:radial-gradient(circle at top left,#111827,#020617 55%);
      padding:10px 12px;
    }
    .box .t { font-size:11px; color:var(--tsoft); margin-bottom:4px; }
    .box .v {
      font-size:18px;
      font-variant-numeric:tabular-nums;
      line-height:1.2;
    }
    .small-row {
      display:flex;
      justify-content:space-between;
      gap:8px;
      margin-top:4px;
      font-size:11px;
      color:var(--tsoft);
    }
    .good { color:var(--good); }
    .bad { color:var(--bad); }
    hr {
      height:1px;
      background:var(--bordersoft);
      border:none;
      margin:10px 0;
    }
    .warn {
      margin-top:6px;
      font-size:11px;
      color:var(--tsoft);
      min-height:1.2em;
    }
    .half-btns {
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:8px;
    }
    @media (max-width:600px) {.half-btns{ grid-template-columns:1fr; } }

    .muted { font-size:11px; color:var(--tsoft); margin-top:4px; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Bybit USDT (Linear Perp) — калькулятор по марже (.P)</h1>
    <div class="subtitle">
      Вводишь маржу в USDT — калькулятор показывает, сколько монет можно открыть с учётом плеча,
      PnL по SL/TP и стоимость пункта. Все USDT линейные перпы подтягиваются с Bybit V5 (с пагинацией).
    </div>

    <div class="grid">
      <!-- Левая колонка: ввод -->
      <div>
        <div class="row">
          <div>
            <label for="direction">Направление</label>
            <select id="direction">
              <option value="long">LONG</option>
              <option value="short">SHORT</option>
            </select>
          </div>
          <div>
            <label for="leverage">Плечо (x)</label>
            <input id="leverage" type="text" placeholder="Например, 20" value="20">
          </div>
        </div>

        <div class="row">
          <div>
            <label for="symbolInput">Инструмент (USDT линейный перп)</label>
            <input id="symbolInput" list="symbolsList" placeholder="Начни вводить: Z или ZORA…">
            <datalist id="symbolsList"></datalist>
            <div class="muted" id="symbolsInfo">
              Загружаю все страницы instruments-info V5 (category=linear, quoteCoin=USDT)…
            </div>
          </div>
          <div>
            <label for="entry">Цена входа</label>
            <input id="entry" type="text" placeholder="Авто-подтяжка, можно изменить вручную">
          </div>
        </div>

        <div class="row">
          <div>
            <label for="margin">Маржа (USDT, сколько готов поставить)</label>
            <input id="margin" type="text" placeholder="Например, 25">
          </div>
          <div>
            <label for="qty">Сколько монет на эту маржу</label>
            <input id="qty" type="text" placeholder="Авторасчёт, можно поправить">
          </div>
        </div>

        <div class="row">
          <div>
            <label for="sl">Stop-Loss цена</label>
            <input id="sl" type="text" placeholder="Например, 2.10">
          </div>
          <div>
            <label for="tp">Take-Profit цена</label>
            <input id="tp" type="text" placeholder="Например, 2.80">
          </div>
        </div>

        <div style="margin-top:8px;">
          <button id="btnCalc" class="btn-primary">Рассчитать</button>
        </div>
        <div class="half-btns">
          <button id="btnUpdate">Обновить цену выбранного инструмента</button>
          <button id="btnClear">Сброс</button>
        </div>
        <div class="warn" id="warn"></div>
      </div>

      <!-- Правая колонка: результаты -->
      <div>
        <div class="kpi">
          <div class="box">
            <div class="t">1) Take-Profit и прибыль (в USDT)</div>
            <div class="v good" id="outTpPnl">—</div>
            <div class="small-row">
              <span>% к марже</span>
              <span id="outTpPct">—</span>
            </div>
          </div>
          <div class="box">
            <div class="t">2) Stop-Loss и убыток (в USDT)</div>
            <div class="v bad" id="outSlPnl">—</div>
            <div class="small-row">
              <span>% к марже</span>
              <span id="outSlPct">—</span>
            </div>
          </div>
        </div>

        <hr>

        <div class="kpi">
          <div class="box">
            <div class="t">3) Номинал позиции (в монетах)</div>
            <div class="v" id="outNominal">—</div>
            <div class="small-row">
              <span>Объём (qty)</span>
              <span id="outQty">—</span>
            </div>
          </div>
          <div class="box">
            <div class="t">4) Стоимость 1 пункта (в USDT)</div>
            <div class="v" id="outTickValue">—</div>
            <div class="small-row">
              <span>Формула</span>
              <span id="tickFormula">qty × tickSize (из биржи)</span>
            </div>
          </div>
        </div>

      </div>
    </div>

  </div>
</div>

<script>
  const symbolsMeta = {};   // { symbol: { tickSize, baseCoin, quoteCoin } }
  let allSymbols = [];      // массив объектов-инструментов

  function parseNum(v) {
    if (typeof v !== 'string') return NaN;
    v = v.replace(/\s+/g, '').replace(',', '.');
    return v === '' ? NaN : Number(v);
  }
  function fmt(v, d = 2) {
    if (!isFinite(v)) return '—';
    return v.toFixed(d);
  }

  function renderSymbolsToDatalist() {
    const dl = document.getElementById('symbolsList');
    dl.innerHTML = '';
    for (const inst of allSymbols) {
      const symbol = inst.symbol;
      const tickSize = inst.priceFilter?.tickSize || '0.0001';
      const opt = document.createElement('option');
      opt.value = symbol;
      opt.label = `${symbol}.P  (tickSize ${tickSize})`;
      dl.appendChild(opt);
    }
  }

  function getSelectedSymbol() {
    const val = document.getElementById('symbolInput').value.trim();
    if (!val) return '';
    const exists = allSymbols.some(inst => inst.symbol === val);
    return exists ? val : '';
  }

  async function fetchAndSetPrice(auto = true) {
    const symbol = getSelectedSymbol();
    const warnEl = document.getElementById('warn');

    if (!symbol) {
      if (!auto) warnEl.textContent = 'Сначала выбери корректный тикер из поля инструмента.';
      return;
    }

    warnEl.textContent = 'Запрашиваю цену с Bybit…';

    try {
      const url = `https://api.bybit.com/v5/market/tickers?category=linear&symbol=${encodeURIComponent(symbol)}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();
      if (data.retCode !== 0 || !data.result || !data.result.list || !data.result.list.length) {
        throw new Error('Нет данных по инструменту');
      }
      const lastPrice = parseFloat(data.result.list[0].lastPrice);
      if (!isFinite(lastPrice) || lastPrice <= 0) throw new Error('Некорректная цена');

      document.getElementById('entry').value = lastPrice.toString();
      warnEl.textContent = auto ? '' : 'Цена обновлена.';
    } catch (e) {
      console.error(e);
      warnEl.textContent = 'Не удалось получить цену с Bybit: ' + e.message;
    }
  }

  function calc() {
    const dir = document.getElementById('direction').value;
    const margin = parseNum(document.getElementById('margin').value);
    const lev = parseNum(document.getElementById('leverage').value);
    const entry = parseNum(document.getElementById('entry').value);
    const sl = parseNum(document.getElementById('sl').value);
    const tp = parseNum(document.getElementById('tp').value);
    const qtyManual = parseNum(document.getElementById('qty').value);
    const symbol = getSelectedSymbol();
    const warnEl = document.getElementById('warn');
    warnEl.textContent = '';

    if (!symbol) {
      warnEl.textContent = 'Выбери корректный тикер из списка (datalist).';
      return;
    }
    if (!isFinite(margin) || margin <= 0) {
      warnEl.textContent = 'Укажи маржу (>0).';
      return;
    }
    if (!isFinite(lev) || lev <= 0) {
      warnEl.textContent = 'Укажи плечо (>0).';
      return;
    }
    if (!isFinite(entry) || entry <= 0) {
      warnEl.textContent = 'Укажи цену входа (>0) или обнови с Bybit.';
      return;
    }

    // === Автоматический расчёт количества монет ===
    let qty;
    if (isFinite(qtyManual) && qtyManual > 0) {
      // если пользователь сам ввёл qty — используем его
      qty = qtyManual;
    } else {
      // иначе считаем автоматически из маржи и плеча
      const notionalUsdt = margin * lev; // сколько USDT в позиции
      qty = notionalUsdt / entry;        // сколько монет по текущей цене
    }
    if (!isFinite(qty) || qty <= 0) {
      warnEl.textContent = 'Не удалось посчитать объём позиции.';
      return;
    }

    // записываем авторассчитанное qty в левое поле
    document.getElementById('qty').value = fmt(qty, 4);

    // номинал в монетах (а не в USDT)
    const nominal = qty;

    let tpPnl = NaN, slPnl = NaN;
    if (isFinite(tp) && tp > 0) {
      tpPnl = (dir === 'long')
        ? (tp - entry) * qty
        : (entry - tp) * qty;
    }
    if (isFinite(sl) && sl > 0) {
      slPnl = (dir === 'long')
        ? (sl - entry) * qty
        : (entry - sl) * qty;
    }

    const tpPct = isFinite(tpPnl) ? (tpPnl / margin) * 100 : NaN;
    const slPct = isFinite(slPnl) ? (slPnl / margin) * 100 : NaN;

    let tickSize = 0.0001;
    if (symbolsMeta[symbol] && symbolsMeta[symbol].tickSize) {
      tickSize = parseFloat(symbolsMeta[symbol].tickSize);
    }
    const tickValue = qty * tickSize; // в USDT

    document.getElementById('outQty').textContent = fmt(qty, 4);
    document.getElementById('outNominal').textContent = fmt(nominal, 4);

    document.getElementById('outTickValue').textContent =
      isFinite(tickValue) ? fmt(tickValue, 6) + ' USDT' : '—';
    document.getElementById('tickFormula').textContent =
      `qty × ${tickSize} (tickSize для ${symbol})`;

    document.getElementById('outTpPnl').textContent =
      isFinite(tpPnl) ? fmt(tpPnl, 2) + ' USDT' : '—';
    document.getElementById('outTpPct').textContent =
      isFinite(tpPct) ? fmt(tpPct, 2) + ' %' : '—';

    document.getElementById('outSlPnl').textContent =
      isFinite(slPnl) ? fmt(slPnl, 2) + ' USDT' : '—';
    document.getElementById('outSlPct').textContent =
      isFinite(slPct) ? fmt(slPct, 2) + ' %' : '—';
  }

  function clearAll() {
    ['margin','leverage','entry','sl','tp','qty','symbolInput'].forEach(id => {
      const el = document.getElementById(id);
      if (id === 'leverage') el.value = '20';
      else el.value = '';
    });
    document.getElementById('warn').textContent = '';
    ['outQty','outNominal','outTickValue','outTpPnl','outTpPct','outSlPnl','outSlPct']
      .forEach(id => document.getElementById(id).textContent = '—');
  }

  async function loadSymbols() {
    const infoEl = document.getElementById('symbolsInfo');
    infoEl.textContent = 'Загружаю список линейных контрактов с Bybit (много страниц)…';

    try {
      let cursor = '';
      const all = [];

      for (let i = 0; i < 20; i++) {
        const url = 'https://api.bybit.com/v5/market/instruments-info?category=linear'
          + (cursor ? '&cursor=' + encodeURIComponent(cursor) : '');
        const res = await fetch(url);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        if (data.retCode !== 0 || !data.result || !data.result.list) {
          throw new Error('API error: ' + (data.retMsg || 'unknown'));
        }

        all.push(...data.result.list);
        cursor = data.result.nextPageCursor || '';
        if (!cursor) break;
      }

      let list = all.filter(inst => inst.quoteCoin === 'USDT');
      list.sort((a,b) => (a.symbol > b.symbol ? 1 : -1));

      allSymbols = list;

      for (const inst of list) {
        const symbol = inst.symbol;
        const tickSize = inst.priceFilter?.tickSize || '0.0001';
        symbolsMeta[symbol] = {
          tickSize: tickSize,
          baseCoin: inst.baseCoin,
          quoteCoin: inst.quoteCoin
        };
      }

      if (list.length === 0) {
        infoEl.textContent = 'Bybit вернул пустой список USDT линейных контрактов.';
      } else {
        renderSymbolsToDatalist();
        infoEl.textContent =
          `Загружено ${list.length} USDT линейных бессрочных фьючерсов. Начни вводить тикер в поле выше.`;
      }
    } catch (e) {
      console.error(e);
      infoEl.textContent = 'Не удалось получить список инструментов: ' + e.message;
    }
  }

  document.getElementById('btnCalc').addEventListener('click', calc);
  document.getElementById('btnClear').addEventListener('click', clearAll);
  document.getElementById('btnUpdate').addEventListener('click', () => fetchAndSetPrice(false));

  ['margin','leverage','entry','sl','tp','qty','symbolInput'].forEach(id => {
    document.getElementById(id).addEventListener('keydown', e => {
      if (e.key === 'Enter') calc();
    });
  });

  // При выборе/изменении инструмента — сразу тянем цену (автоматически)
  document.getElementById('symbolInput').addEventListener('change', () => {
    fetchAndSetPrice(true);
  });

  loadSymbols();
</script>
</body>
</html>
