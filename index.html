<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bybit USDT (Linear Perp) — калькулятор по марже (.P)</title>
  <style>
    :root {
      --bg: #050816;
      --card: #0b1220;
      --border: rgba(255, 255, 255, 0.08);
      --t: #f9fafb;
      --tsoft: #9ca3af;
      --good: #22c55e;
      --bad: #ef4444;
      --inputbg: #020617;
      --dropdown-bg: #020617;
      --dropdown-border: rgba(255,255,255,0.15);
      --dropdown-hover: #111827;
    }
    *,*::before,*::after{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
      background:radial-gradient(circle at top,#111827,#020617 55%);
      color:var(--t);
    }
    .wrap{max-width:1180px;margin:20px auto;padding:0 14px 24px;}
    .card{
      background:var(--card);
      border-radius:18px;
      border:1px solid var(--border);
      padding:18px 18px 20px;
      box-shadow:0 18px 45px rgba(0,0,0,0.55);
      max-width:640px;
    }
    h1{margin:0 0 8px;font-size:18px;font-weight:600;}
    .subtitle{margin-bottom:14px;font-size:12px;color:var(--tsoft);}
    label{
      display:block;
      margin:6px 0 4px;
      font-size:12px;
      color:var(--tsoft);
    }
    input,select,button{
      width:100%;
      padding:9px 11px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--inputbg);
      color:var(--t);
      font-size:13px;
      font-family:inherit;
      outline:none;
    }
    input::placeholder{color:#6b7280;}
    button{
      background:#111827;
      font-weight:600;
      cursor:pointer;
      transition:background .15s,transform .05s;
    }
    button:hover{background:#1f2937;}
    button:active{transform:translateY(1px);}
    .grid{
      display:grid;
      grid-template-columns:1fr;
      gap:14px;
    }
    .row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-bottom:6px;
    }
    @media(max-width:600px){.row{grid-template-columns:1fr;}}
    .warn{margin-top:6px;font-size:11px;color:var(--tsoft);min-height:1.2em;}
    .half-btns{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:8px;
    }
    @media(max-width:600px){.half-btns{grid-template-columns:1fr;}}
    .muted{font-size:11px;color:var(--tsoft);margin-top:4px;}
    .live-pnl{
      font-size:11px;
      margin-top:3px;
      min-height:1.2em;
    }
    .live-pnl .v{font-variant-numeric:tabular-nums;}
    .good{color:var(--good);}
    .bad{color:var(--bad);}

    .symbol-combobox{position:relative;}
    .symbol-dropdown{
      position:absolute;
      left:0;right:0;top:100%;
      margin-top:4px;
      max-height:220px;
      overflow-y:auto;
      background:var(--dropdown-bg);
      border-radius:10px;
      border:1px solid var(--dropdown-border);
      box-shadow:0 12px 30px rgba(0,0,0,0.6);
      z-index:20;
    }
    .symbol-option{
      padding:6px 10px;
      font-size:13px;
      cursor:pointer;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .symbol-option:hover{background:var(--dropdown-hover);}
    .symbol-symbol{font-weight:500;}
    .symbol-extra{
      font-size:11px;
      color:var(--tsoft);
      margin-left:8px;
    }
    .hidden{display:none;}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Bybit USDT (Linear Perp) — калькулятор по марже (.P)</h1>
    <div class="subtitle">
      Вводишь маржу в USDT — калькулятор показывает, сколько монет можно открыть с учётом плеча,
      и считает PnL по SL/TP. Инструменты берутся с Bybit V5.
    </div>

    <div class="grid">
      <div>
        <div class="row">
          <div>
            <label for="direction">Направление</label>
            <select id="direction">
              <option value="long">LONG</option>
              <option value="short">SHORT</option>
            </select>
          </div>
          <div>
            <label for="leverage">Плечо (x)</label>
            <select id="leverage">
              <option value="5">5</option>
              <option value="10">10</option>
              <option value="15">15</option>
              <option value="20" selected>20</option>
              <option value="25">25</option>
              <option value="30">30</option>
              <option value="35">35</option>
              <option value="40">40</option>
              <option value="45">45</option>
              <option value="50">50</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="symbolInput">Инструмент (USDT линейный перп)</label>
            <div class="symbol-combobox">
              <input id="symbolInput" type="text" placeholder="Начни вводить тикер, напр. BTCUSDT">
              <div id="symbolDropdown" class="symbol-dropdown hidden"></div>
            </div>
            <div class="muted" id="symbolsInfo">
              Загружаю список instruments-info V5 (category=linear, quoteCoin=USDT)…
            </div>
          </div>
          <div>
            <label for="entry">Цена входа</label>
            <input id="entry" type="text" placeholder="Авто-подтяжка, можно изменить вручную">
          </div>
        </div>

        <div class="row">
          <div>
            <label for="margin">Маржа (USDT, сколько готов поставить)</label>
            <input id="margin" type="text" placeholder="Например, 60">
          </div>
          <div>
            <label for="qty">Сколько монет на эту маржу</label>
            <input id="qty" type="text" placeholder="Авторасчёт, можно поправить">
            <div class="muted">
              Если изменить qty вручную — SL/TP будут считаться по этому объёму.
            </div>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="sl">Stop-Loss цена</label>
            <input id="sl" type="text" placeholder="Например, 0.280">
            <div id="slLive" class="live-pnl"></div>
          </div>
          <div>
            <label for="tp">Take-Profit цена</label>
            <input id="tp" type="text" placeholder="Например, 0.320">
            <div id="tpLive" class="live-pnl"></div>
          </div>
        </div>

        <div class="half-btns">
          <button id="btnUpdate">Обновить цену выбранного инструмента</button>
          <button id="btnClear">Сброс</button>
        </div>
        <div class="warn" id="warn"></div>
      </div>
    </div>

  </div>
</div>

<script>
  let allSymbols = [];
  let selectedSymbol = '';

  function parseNum(v){
    if(typeof v!=='string')return NaN;
    v=v.replace(/\s+/g,'').replace(',', '.');
    return v===''?NaN:Number(v);
  }
  function fmt(v,d=2){
    if(!isFinite(v))return '—';
    return v.toFixed(d);
  }

  function renderSymbolDropdown(filterText=''){
    const dd = document.getElementById('symbolDropdown');
    dd.innerHTML = '';

    const q = filterText.trim().toUpperCase();
    let list = allSymbols;

    if(q){
      list = allSymbols.filter(inst =>
        inst.symbol.toUpperCase().startsWith(q)
      );
    }

    if(!list.length){
      const div = document.createElement('div');
      div.className = 'symbol-option';
      div.textContent = 'Инструменты не найдены';
      dd.appendChild(div);
      return;
    }

    list.slice(0,300).forEach(inst=>{
      const div = document.createElement('div');
      div.className = 'symbol-option';
      const left = document.createElement('span');
      left.className = 'symbol-symbol';
      left.textContent = inst.symbol + '.P';
      const right = document.createElement('span');
      right.className = 'symbol-extra';
      right.textContent = `tick ${inst.priceFilter?.tickSize || '0.0001'}`;
      div.appendChild(left);
      div.appendChild(right);
      div.addEventListener('click',()=>{
        selectedSymbol = inst.symbol;
        document.getElementById('symbolInput').value = inst.symbol;
        dd.classList.add('hidden');
        fetchAndSetPrice(true);
      });
      dd.appendChild(div);
    });
  }

  async function fetchAndSetPrice(auto=true){
    const warnEl=document.getElementById('warn');
    if(!selectedSymbol){
      if(!auto) warnEl.textContent='Сначала выбери тикер.';
      return;
    }
    warnEl.textContent='Запрашиваю цену с Bybit…';
    try{
      const url=`https://api.bybit.com/v5/market/tickers?category=linear&symbol=${encodeURIComponent(selectedSymbol)}`;
      const res=await fetch(url);
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data=await res.json();
      if(data.retCode!==0||!data.result||!data.result.list||!data.result.list.length){
        throw new Error('Нет данных по инструменту');
      }
      const lastPrice=parseFloat(data.result.list[0].lastPrice);
      if(!isFinite(lastPrice)||lastPrice<=0) throw new Error('Некорректная цена');

      // цена входа
      document.getElementById('entry').value = lastPrice.toString();
      // новое: сразу ставим ту же цену в SL и TP
      document.getElementById('sl').value = lastPrice.toString();
      document.getElementById('tp').value = lastPrice.toString();

      warnEl.textContent=auto?'':'Цена обновлена.';
      updateQtyAuto();
      updateLivePnL();
    }catch(e){
      console.error(e);
      warnEl.textContent='Не удалось получить цену с Bybit: '+e.message;
    }
  }

  function updateQtyAuto(){
    const margin=parseNum(document.getElementById('margin').value);
    const lev=parseNum(document.getElementById('leverage').value);
    const entry=parseNum(document.getElementById('entry').value);
    if(!selectedSymbol||!isFinite(margin)||margin<=0||
       !isFinite(lev)||lev<=0||
       !isFinite(entry)||entry<=0) return;
    const notional=margin*lev;
    const qty=notional/entry;
    if(!isFinite(qty)||qty<=0) return;
    document.getElementById('qty').value=fmt(qty,4);
  }

  function updateLivePnL(){
    const dir=document.getElementById('direction').value;
    const margin=parseNum(document.getElementById('margin').value);
    const lev=parseNum(document.getElementById('leverage').value);
    const entry=parseNum(document.getElementById('entry').value);
    const tp=parseNum(document.getElementById('tp').value);
    const sl=parseNum(document.getElementById('sl').value);
    const qtyManual=parseNum(document.getElementById('qty').value);

    const tpEl=document.getElementById('tpLive');
    const slEl=document.getElementById('slLive');
    tpEl.textContent='';
    slEl.textContent='';

    if(!selectedSymbol||!isFinite(margin)||margin<=0||
       !isFinite(lev)||lev<=0||
       !isFinite(entry)||entry<=0) return;

    let qty;
    if(isFinite(qtyManual)&&qtyManual>0){
      qty=qtyManual;
    }else{
      const notional=margin*lev;
      qty=notional/entry;
    }
    if(!isFinite(qty)||qty<=0) return;

    if(isFinite(tp)&&tp>0){
      let tpPnl=(dir==='long') ? (tp-entry)*qty : (entry-tp)*qty;
      let tpPct=(tpPnl/margin)*100;
      const signPnl=tpPnl>=0?'+':'-';
      const signPct=tpPct>=0?'+':'-';
      const cls=tpPnl>=0?'good':'bad';
      tpEl.innerHTML=
        `<span class="${cls} v">${signPnl} ${fmt(Math.abs(tpPnl),2)} USDT</span>`+
        ` &nbsp; (${signPct} ${fmt(Math.abs(tpPct),2)} %)`;
    }

    if(isFinite(sl)&&sl>0){
      let slPnl=(dir==='long') ? (sl-entry)*qty : (entry-sl)*qty;
      let slPct=(slPnl/margin)*100;
      const signPnl=slPnl>=0?'+':'-';
      const signPct=slPct>=0?'+':'-';
      const cls=slPnl>=0?'good':'bad';
      slEl.innerHTML=
        `<span class="${cls} v">${signPnl} ${fmt(Math.abs(slPnl),2)} USDT</span>`+
        ` &nbsp; (${signPct} ${fmt(Math.abs(slPct),2)} %)`;
    }
  }

  function clearAll(){
    selectedSymbol='';
    document.getElementById('symbolInput').value='';
    ['margin','entry','sl','tp','qty'].forEach(id=>{
      document.getElementById(id).value='';
    });
    document.getElementById('leverage').value='20';
    document.getElementById('warn').textContent='';
    document.getElementById('tpLive').textContent='';
    document.getElementById('slLive').textContent='';
  }

  async function loadSymbols(){
    const infoEl=document.getElementById('symbolsInfo');
    infoEl.textContent='Загружаю список линейных контрактов с Bybit…';
    try{
      let cursor='';
      const all=[];
      for(let i=0;i<20;i++){
        const url='https://api.bybit.com/v5/market/instruments-info?category=linear'
          +(cursor?'&cursor='+encodeURIComponent(cursor):'');
        const res=await fetch(url);
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data=await res.json();
        if(data.retCode!==0||!data.result||!data.result.list){
          throw new Error('API error: '+(data.retMsg||'unknown'));
        }
        all.push(...data.result.list);
        cursor=data.result.nextPageCursor||'';
        if(!cursor) break;
      }
      let list=all.filter(inst=>inst.quoteCoin==='USDT');
      list.sort((a,b)=>a.symbol.localeCompare(b.symbol));
      allSymbols=list;
      if(!list.length){
        infoEl.textContent='Bybit вернул пустой список USDT линейных контрактов.';
      }else{
        infoEl.textContent=`Загружено ${list.length} USDT линейных бессрочных фьючерсов. Начни вводить тикер.`;
        renderSymbolDropdown('');
      }
    }catch(e){
      console.error(e);
      infoEl.textContent='Не удалось получить список инструментов: '+e.message;
    }
  }

  document.getElementById('btnClear').addEventListener('click',clearAll);
  document.getElementById('btnUpdate').addEventListener('click',()=>fetchAndSetPrice(false));

  ['margin','entry','tp','sl','qty'].forEach(id=>{
    document.getElementById(id).addEventListener('input',()=>{
      if(id==='margin'||id==='entry') updateQtyAuto();
      updateLivePnL();
    });
  });
  document.getElementById('direction').addEventListener('change',updateLivePnL);
  document.getElementById('leverage').addEventListener('change',()=>{
    updateQtyAuto();
    updateLivePnL();
  });

  const symbolInput=document.getElementById('symbolInput');
  const symbolDropdown=document.getElementById('symbolDropdown');

  symbolInput.addEventListener('focus',()=>{
    symbolDropdown.classList.remove('hidden');
    renderSymbolDropdown(symbolInput.value);
  });
  symbolInput.addEventListener('input',()=>{
    selectedSymbol='';
    symbolDropdown.classList.remove('hidden');
    renderSymbolDropdown(symbolInput.value);
  });

  document.addEventListener('click',(e)=>{
    if(!e.target.closest('.symbol-combobox')){
      symbolDropdown.classList.add('hidden');
    }
  });

  loadSymbols();
</script>
</body>
</html>
